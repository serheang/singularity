Bootstrap: docker
From: ros:melodic-robot

%help
ROS Melodic on Ubuntu 18.04 with additional packages for the subject 49274 Advanced Robotics running in singularity container (https://sylabs.io)

If you run the Singularity without parameters, it will give you a bash shell prompt within the ROS Singularity container.

Usage:
singularity exec ros-melodic-ar.sif [commands]
or
singularity shell ros-melodic-ar.sif

Example: 
singularity exec ros-melodic-ar.sif lsb_release -a

%labels
  AUTHOR Brenton Leighton brenton.leighton@uts.edu.au
  MAINTAINER Brenton Leighton
  WHATAMI ROS Melodic Singularity container
  VERSION 1.0

%files

%post
# Use the Australian mirror
  sed -i 's|http://archive.ubuntu.com|http://au.archive.ubuntu.com|g' /etc/apt/sources.list

# Update and upgrade system
  apt update
  apt upgrade -y

# Install ROS desktop full and other packages
  apt install -y ros-melodic-desktop-full ros-melodic-map-server \
      ros-melodic-teleop-twist-keyboard ros-melodic-turtlebot3 \
      ros-melodic-turtlebot3-simulations qtcreator

# For checking VirtualGL performance
  apt install -y mesa-utils

# Clean up
  apt autoremove -y
  apt clean
  apt autoclean

%environment
  NAME="ROS Melodic"
  CONTAINER="ros-melodic-ar.sif"
  export NAME CONTAINER
  if [ -f ~/catkin_ws/devel/setup.sh ]
  then
      . ~/catkin_ws/devel/setup.sh
  elif [ -f ~/catkin_ws/devel_isolated/setup.sh ]
  then
      . ~/catkin_ws/devel_isolated/setup.sh
  else
      . /opt/ros/melodic/setup.sh
  fi

%startscript
  echo "Starting $NAME roscore"
  exec "roscore"

%runscript
#!/bin/bash
if [[ -z ${@} ]]; then
  echo "This is ${NAME} singularity container.  Please execute with some commands:"
  echo "$ singularity exec ${CONTAINER} lsb_release -a"
  echo ""
  echo "Or if you just want a BASH shell:"
  echo "$ singularity shell ${CONTAINER}"
  echo ""
  echo "To learn more about singularity, please go to https://sylabs.io"
else 
  echo "This is ${NAME} singularity container.  Please execute with some commands:"
  echo "$ singularity exec ${CONTAINER} lsb_release -a"
fi
